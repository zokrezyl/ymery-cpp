name: Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # Desktop OpenGL build
  opengl:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libx11-dev \
          libxrandr-dev \
          libxinerama-dev \
          libxcursor-dev \
          libxi-dev \
          libxext-dev \
          libgl1-mesa-dev \
          libglu1-mesa-dev \
          pkg-config \
          ninja-build

    - name: Configure CMake
      run: >
        cmake -B build-opengl -G Ninja
        -DCMAKE_BUILD_TYPE=Release
        -DCMAKE_POLICY_VERSION_MINIMUM=3.5
        -DYMERY_USE_WEBGPU=OFF
        -DYMERY_BUILD_GUI_TESTS=ON

    - name: Build
      run: cmake --build build-opengl --parallel

    - name: Test
      working-directory: build-opengl
      run: ctest --output-on-failure

  # Desktop WebGPU build
  webgpu:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libx11-dev \
          libxrandr-dev \
          libxinerama-dev \
          libxcursor-dev \
          libxi-dev \
          libxext-dev \
          libgl1-mesa-dev \
          libglu1-mesa-dev \
          pkg-config \
          ninja-build

    - name: Configure CMake
      run: >
        cmake -B build-webgpu -G Ninja
        -DCMAKE_BUILD_TYPE=Release
        -DCMAKE_POLICY_VERSION_MINIMUM=3.5
        -DYMERY_USE_WEBGPU=ON
        -DYMERY_BUILD_GUI_TESTS=ON

    - name: Build
      run: cmake --build build-webgpu --parallel

    - name: Test
      working-directory: build-webgpu
      run: ctest --output-on-failure

  # Android OpenGL build
  android-opengl:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Build OpenGL APK
      working-directory: android/ymery
      run: |
        chmod +x ./gradlew 2>/dev/null || true
        ./gradlew assembleOpenglDebug --no-daemon

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: ymery-android-opengl-debug
        path: android/ymery/app/build/outputs/apk/opengl/debug/*.apk

  # Android WebGPU build
  android-webgpu:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Download wgpu-native
      run: |
        cd android/ymery
        chmod +x ./build-wgpu.sh
        ./build-wgpu.sh

    - name: Build WebGPU APK
      working-directory: android/ymery
      run: |
        chmod +x ./gradlew 2>/dev/null || true
        ./gradlew assembleWebgpuDebug --no-daemon

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: ymery-android-webgpu-debug
        path: android/ymery/app/build/outputs/apk/webgpu/debug/*.apk
