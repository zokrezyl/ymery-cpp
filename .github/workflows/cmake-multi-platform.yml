name: Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # Desktop OpenGL build
  desktop-opengl:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libx11-dev \
          libxrandr-dev \
          libxinerama-dev \
          libxcursor-dev \
          libxi-dev \
          libxext-dev \
          libgl1-mesa-dev \
          libglu1-mesa-dev \
          libasound2-dev \
          libjack-jackd2-dev \
          libpipewire-0.3-dev \
          pkg-config \
          ninja-build

    - name: Build and Test
      run: make test-desktop-opengl

  # Desktop WebGPU build
  desktop-webgpu:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libx11-dev \
          libxrandr-dev \
          libxinerama-dev \
          libxcursor-dev \
          libxi-dev \
          libxext-dev \
          libgl1-mesa-dev \
          libglu1-mesa-dev \
          libasound2-dev \
          libjack-jackd2-dev \
          libpipewire-0.3-dev \
          pkg-config \
          ninja-build

    - name: Build and Test
      run: make test-desktop-webgpu

  # Android OpenGL build
  android-opengl:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Build and Test
      run: make test-android-opengl

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: ymery-android-opengl-debug
        path: build-tools/android/ymery/app/build/outputs/apk/opengl/debug/*.apk

  # Android WebGPU build
  android-webgpu:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Build and Test
      run: make test-android-webgpu

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: ymery-android-webgpu-debug
        path: build-tools/android/ymery/app/build/outputs/apk/webgpu/debug/*.apk

  # WebAssembly WebGPU build
  webasm-webgpu:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Nix
      uses: cachix/install-nix-action@v27
      with:
        nix_path: nixpkgs=channel:nixos-unstable

    - name: Build and Test
      run: make test-webasm-webgpu
